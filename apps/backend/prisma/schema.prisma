// ==========================================================
//  PRISMA SCHEMA — DIRECT TRANSF'AIR (SAAS EDITION)
//  CORRECTED & COMPLETE
// ==========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================

enum Role {
  SUPER_ADMIN    // Toi (Gère les sociétés)
  COMPANY_ADMIN  // Le patron d'une société cliente (Gère ses agences)
  AGENT          // L'employé dans une agence (Fait les dépôts/retraits)
  USER           // Le client final (Envoie de l'argent depuis son canapé)
}

enum SubscriptionType {
  RENTAL   // Location mensuelle/trimestrielle
  PURCHASE // Achat définitif
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum TransactionStatus {
  PENDING
  VALIDATED
  PAID
  CANCELLED
}

enum PayoutMethod {
  CASH_PICKUP
  BANK_DEPOSIT
  MOBILE_MONEY
  WALLET
}

enum PaymentMethod {
  WALLET
  ORANGE_MONEY
  SENDWAVE
  CARD
  CASH // Pour les dépôts en agence
}

// ✅ CES ENUMS MANQUAIENT DANS LA VERSION PRÉCÉDENTE
enum PaymentProvider {
  DIRECT
  ORANGE_MONEY
  SENDWAVE
}

enum ProviderStatus {
  PENDING
  SUCCESS
  FAILED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

// ===================== CLIENT (LA SOCIÉTÉ) =====================

model Client {
  id   Int    @id @default(autoincrement())
  code String @unique // Ex: "DONIKO", "WARI", "WESTERN"
  name String

  // --- Configuration Visuelle (Phase 1) ---
  logoUrl      String?
  primaryColor String? @default("#F7931E")
  
  // --- Infos Légales & Représentant ---
  address            String?
  phone              String?
  email              String?
  representativeName String?
  representativeDocs String? // URL vers PDF

  // --- Module Abonnement (Phase 1) ---
  subscriptionType   SubscriptionType   @default(RENTAL)
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  subscriptionEnd    DateTime?          // Date fin d'abonnement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  agencies      Agency[]      // Une société a plusieurs agences
  beneficiaries Beneficiary[]
  transactions  Transaction[]
  withdrawals   Withdrawal[]
}

// ===================== AGENCY (L'AGENCE PHYSIQUE) =====================

model Agency {
  id        String @id @default(cuid())
  name      String // Ex: "Agence Paris 18"
  city      String
  address   String
  phone     String?
  
  // Solde de l'agence
  balance       Decimal @default(0) @db.Decimal(12, 2)
  creditLimit   Decimal @default(0) @db.Decimal(12, 2) // Découvert autorisé

  isActive      Boolean @default(true)

  clientId  Int
  client    Client @relation(fields: [clientId], references: [id])

  agents    User[]  @relation("AgencyAgents") // Les employés de cette agence
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== USER (ACTEURS) =====================

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     Role   @default(USER)

  // --- Identité ---
  firstName String?
  lastName  String?
  phone     String?
  gender    String? 
  jobTitle  String?

  // --- Adresse ---
  addressStreet String?
  postalCode    String?
  city          String?
  country       String?

  // --- État Civil ---
  nationality String?
  birthDate   String?
  birthPlace  String?

  // --- Financier (Client Final) ---
  balance Decimal @default(0) @db.Decimal(12, 2)

  // --- Relations ---
  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  // Si c'est un AGENT, il appartient à une agence
  agencyId  String?
  agency    Agency? @relation("AgencyAgents", fields: [agencyId], references: [id])

  transactions  Transaction[]
  beneficiaries Beneficiary[]

  // Pour les agents/admins qui valident des opérations
  processedWithdrawals Withdrawal[] @relation("ProcessedWithdrawals")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== BENEFICIARY =====================

model Beneficiary {
  id       String  @id @default(cuid())
  fullName String
  country  String
  city     String
  phone    String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== TRANSACTION =====================

model Transaction {
  id        String @id @default(cuid())
  reference String @unique

  amount Decimal @db.Decimal(12, 2)
  fees   Decimal @db.Decimal(12, 2)
  total  Decimal @db.Decimal(12, 2)

  currency String

  status       TransactionStatus @default(PENDING)
  payoutMethod PayoutMethod      @default(CASH_PICKUP)

  paymentMethod  PaymentMethod    @default(WALLET)
  
  // Utilisation des enums ajoutés
  provider       PaymentProvider?
  providerRef    String?
  providerStatus ProviderStatus?  @default(PENDING)
  
  senderId String
  sender   User   @relation(fields: [senderId], references: [id])

  beneficiaryId String
  beneficiary   Beneficiary @relation(fields: [beneficiaryId], references: [id])

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  withdrawal Withdrawal?

  paidAt      DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== WITHDRAWAL =====================

model Withdrawal {
  id String @id @default(cuid())

  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  method PayoutMethod
  // Utilisation de l'enum ajouté
  status WithdrawalStatus @default(PENDING)

  requestedAt DateTime  @default(now())
  processedAt DateTime?

  processedById String?
  processedBy   User?   @relation("ProcessedWithdrawals", fields: [processedById], references: [id])

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])
}

// ===================== TAUX DE CHANGE =====================

model ExchangeRate {
  id        String   @id @default(cuid())
  pair      String   @unique
  rate      Float
  updatedAt DateTime @updatedAt
}